<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload | VYBE VAULT</title>
  <meta name="description" content="Admin upload portal for VYBE VAULT assets." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=9" />
</head>
<body>
  <div id="build-counter" style="position:fixed;top:10px;right:10px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.2);background:rgba(7,10,16,0.85);color:#cfd7e6;font:12px/1 'Space Grotesk',sans-serif;letter-spacing:0.04em;z-index:9999;">
    BUILD v22
  </div>
  <div class="bg-grid" aria-hidden="true"></div>

  <header class="site-header">
    <a class="brand" href="index.html">VYBE VAULT</a>
    <nav>
      <a href="index.html">home</a>
      <a href="assets.html">assets</a>
      <a href="upload.html" class="active">upload</a>
      <a href="pricing.html">pricing</a>
      <a href="tos.html">tos</a>
      <a href="privacy-policy.html">privacy</a>
    </nav>
    <div class="auth-controls">
      <span class="auth-label" id="auth-user-label" aria-live="polite">signed out</span>
      <button class="btn btn-ghost auth-btn" id="discord-login-btn" type="button">login with Discord</button>
    </div>
  </header>

  <main>
    <section class="section page-hero">
      <p class="hero-kicker reveal">admin portal</p>
      <h1 class="reveal">upload assets</h1>
      <p class="hero-copy reveal">Only approved admin accounts can access this page.</p>
    </section>

    <section class="section reveal">
      <div class="admin-card">
        <h2>new asset</h2>
        <p class="section-copy" id="upload-gate-status">Checking admin access...</p>
        <form id="asset-upload-form" class="upload-form" action="#" onsubmit="return false;">
          <label>
            <span>Title</span>
            <input id="upload-title" type="text" required />
          </label>
          <label>
            <span>Description</span>
            <textarea id="upload-description" rows="3" placeholder="Optional"></textarea>
          </label>
          <label>
            <span>Required tier</span>
            <select id="upload-tier">
              <option value="creator">Creator</option>
              <option value="creator_plus">Creator+</option>
              <option value="creator_plus_plus">Creator++</option>
            </select>
          </label>
          <label>
            <span>Tags (comma separated)</span>
            <input id="upload-tags" type="text" placeholder="overlay, transitions, cinematic" />
          </label>
          <label>
            <span>Asset file</span>
            <input id="upload-file" type="file" required />
          </label>
          <label class="publish-toggle">
            <input id="upload-published" type="checkbox" checked />
            <span>Publish immediately</span>
          </label>
          <button class="btn btn-primary" id="upload-submit-btn" type="button">upload asset</button>
        </form>
        <p id="upload-status" class="assets-status"></p>
      </div>
    </section>
  </main>

  <div id="upload-overlay" class="upload-overlay hidden" aria-hidden="true">
    <div class="upload-overlay-card">
      <p id="upload-overlay-text">Uploading...</p>
      <div class="upload-progress-track">
        <div id="upload-progress-bar" class="upload-progress-bar"></div>
      </div>
      <p id="upload-progress-pct" class="upload-progress-pct">0%</p>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; <span id="year"></span> VYBE VAULT. all rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth-config.js"></script>
  <script src="script.js?v=22"></script>
  <script>
    window.__uploadScriptLoaded = true;
    const authConfig = window.VYBE_AUTH_CONFIG || {};
    const supabaseFactory = window.supabase;
    const supabasePublicKey =
      authConfig.supabaseAnonKey || authConfig.supabasePublishableKey || "";

    const uploadForm = document.getElementById("asset-upload-form");
    const uploadStatus = document.getElementById("upload-status");
    const uploadGateStatus = document.getElementById("upload-gate-status");
    const uploadSubmitBtn = document.getElementById("upload-submit-btn");
    const uploadOverlay = document.getElementById("upload-overlay");
    const uploadOverlayText = document.getElementById("upload-overlay-text");
    const uploadProgressBar = document.getElementById("upload-progress-bar");
    const uploadProgressPct = document.getElementById("upload-progress-pct");

    let supabaseClient = null;
    let currentSession = null;
    let uploadReady = false;

    const redirectToAssets = () => {
      window.location.replace("assets.html");
    };

    const withTimeout = async (promise, timeoutMs, label) => {
      let timeoutId;
      const timeoutPromise = new Promise((_, reject) => {
        timeoutId = setTimeout(() => reject(new Error(`${label} timed out`)), timeoutMs);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    const toSlug = (value) =>
      value
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 64);

    const getTagsFromText = (text) => {
      return [...new Set(
        String(text || "")
          .split(",")
          .map((tag) => tag.trim().toLowerCase())
          .filter(Boolean)
      )];
    };

    const setOverlay = (percent, text) => {
      if (uploadProgressBar) {
        uploadProgressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
      }
      if (uploadProgressPct) {
        uploadProgressPct.textContent = `${Math.round(percent)}%`;
      }
      if (uploadOverlayText) {
        uploadOverlayText.textContent = text;
      }
    };

    const openOverlay = () => {
      if (uploadOverlay) {
        uploadOverlay.classList.remove("hidden");
      }
      document.body.classList.add("uploading");
    };

    const closeOverlay = () => {
      if (uploadOverlay) {
        uploadOverlay.classList.add("hidden");
      }
      document.body.classList.remove("uploading");
    };

    const checkAdminAccess = async (userId) => {
      if (!userId || !supabaseClient) {
        return false;
      }
      const configuredAdminId =
        typeof authConfig.adminUserId === "string" ? authConfig.adminUserId.trim() : "";
      if (configuredAdminId && configuredAdminId === userId) {
        return true;
      }
      try {
        const { data, error } = await withTimeout(
          supabaseClient
            .from("site_admins")
            .select("user_id")
            .eq("user_id", userId)
            .maybeSingle(),
          12000,
          "admin check"
        );
        if (error) {
          return false;
        }
        return Boolean(data?.user_id);
      } catch (_err) {
        return false;
      }
    };

    const ensureAuthorizedForUpload = async () => {
      if (!supabaseClient) {
        return { ok: false, reason: "Supabase client not ready." };
      }
      try {
        const { data } = await withTimeout(
          supabaseClient.auth.getSession(),
          12000,
          "getSession"
        );
        currentSession = data?.session || null;
      } catch (_error) {
        return { ok: false, reason: "Session check timed out." };
      }

      if (!currentSession?.user?.id) {
        return { ok: false, reason: "Not signed in." };
      }

      const isAdmin = await checkAdminAccess(currentSession.user.id);
      if (!isAdmin) {
        return { ok: false, reason: "This account is not an admin." };
      }

      return { ok: true };
    };

    const handleUploadSubmit = async () => {
      if (!uploadStatus) {
        return;
      }
      uploadStatus.textContent = "Checking account access...";
      const authCheck = await ensureAuthorizedForUpload();
      if (!authCheck.ok) {
        uploadStatus.textContent = authCheck.reason;
        if (authCheck.reason === "Not signed in.") {
          redirectToAssets();
        }
        return;
      }

      const title = document.getElementById("upload-title")?.value?.trim();
      const description = document.getElementById("upload-description")?.value?.trim() || null;
      const requiredTier = document.getElementById("upload-tier")?.value || "creator";
      const tagsText = document.getElementById("upload-tags")?.value || "";
      const uploadFileInput = document.getElementById("upload-file");
      const file = uploadFileInput?.files?.[0];

      if (!title || !file) {
        uploadStatus.textContent = "Title and file are required.";
        return;
      }

      const ext = file.name.includes(".") ? file.name.slice(file.name.lastIndexOf(".")).toLowerCase() : "";
      const slugBase = toSlug(title) || `asset-${Date.now()}`;
      const slug = `${slugBase}-${Date.now()}`;
      const objectPath = `${slug}${ext}`;
      const tags = getTagsFromText(tagsText);

      uploadSubmitBtn.disabled = true;
      uploadStatus.textContent = "";
      openOverlay();
      setOverlay(4, "Preparing upload...");

      let progress = 4;
      const progressTimer = setInterval(() => {
        progress = Math.min(progress + Math.random() * 6, 82);
        setOverlay(progress, "Uploading file...");
      }, 220);

      try {
        const uploadResult = await supabaseClient.storage
          .from("asset-files")
          .upload(objectPath, file, { upsert: false });

        clearInterval(progressTimer);
        if (uploadResult.error) {
          throw new Error(uploadResult.error.message);
        }

        setOverlay(88, "Saving asset record...");
        const insertResult = await supabaseClient
          .from("assets")
          .insert({
            slug,
            title,
            description,
            required_tier: requiredTier,
            tags,
            storage_object_path: objectPath,
            is_published: true
          });

        if (insertResult.error) {
          throw new Error(insertResult.error.message);
        }

        setOverlay(100, "Uploaded");
        uploadStatus.textContent = "Asset uploaded successfully.";
        uploadForm.reset();

        setTimeout(() => {
          closeOverlay();
          uploadSubmitBtn.disabled = false;
          uploadStatus.textContent = "";
        }, 1500);
      } catch (error) {
        clearInterval(progressTimer);
        setOverlay(100, "Upload failed");
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        setTimeout(() => {
          closeOverlay();
          uploadSubmitBtn.disabled = false;
        }, 900);
      }
    };

    const initUploadPage = async () => {
      if (uploadSubmitBtn) {
        uploadSubmitBtn.addEventListener("click", handleUploadSubmit);
      }

      const canInitAuth =
        typeof supabaseFactory?.createClient === "function" &&
        typeof authConfig.supabaseUrl === "string" &&
        authConfig.supabaseUrl.includes("supabase.co") &&
        typeof supabasePublicKey === "string" &&
        supabasePublicKey.length > 20;

      if (!canInitAuth) {
        uploadStatus.textContent = "Auth config missing.";
        return;
      }

      supabaseClient = supabaseFactory.createClient(
        authConfig.supabaseUrl,
        supabasePublicKey,
        {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true
          }
        }
      );

      const authCheck = await ensureAuthorizedForUpload();
      if (authCheck.ok) {
        uploadReady = true;
        if (uploadGateStatus) {
          uploadGateStatus.textContent = "Admin verified. Ready to upload.";
        }
        return;
      }

      if (uploadGateStatus) {
        uploadGateStatus.textContent = authCheck.reason;
      }
      if (authCheck.reason === "Not signed in.") {
        redirectToAssets();
      }
    };

    initUploadPage();
  </script>
</body>
</html>
